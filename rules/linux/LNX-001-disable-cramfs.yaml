metadata:
  benchmark: CIS Linux Benchmarks v3.0.0
  os: linux
  distros:
    - ubuntu
    - debian
    - rhel
    - centos
    - fedora
  versions:
    ubuntu: ['20.04', '22.04', '24.04']
    debian: ['10', '11', '12']
    rhel: ['7', '8', '9']
    centos: ['7', '8', '9']
    fedora: ['36', '37', '38']

rule:
  id: LNX-001
  category: Filesystem
  subcategory: Kernel Modules
  description: Ensure cramfs kernel module is not available
  severity: medium
  
  audit:
    cis_reference: 1.1.1.1
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: The cramfs filesystem type is a compressed read-only Linux filesystem embedded in small footprint systems. Removing support for unneeded filesystem types reduces the local attack surface of the system.
    impact: Cramfs filesystem will not be available for use. This filesystem is rarely used in modern systems.
  
  hardening_levels:
    basic:
      enabled: true
      value: disabled
    moderate:
      enabled: true
      value: disabled
    strict:
      enabled: true
      value: disabled
  
check:
  type: command
  command: |
    # Check if module is loaded
    if lsmod | grep -q "^cramfs"; then
      echo "loaded"
      exit 1
    fi
      
    # Check if module is available but not loaded
    if modprobe -n -v cramfs 2>&1 | grep -qv "install /bin/true"; then
      echo "available"
      exit 1
    fi
      
    # Check if module is blacklisted
    if grep -Rq "^install cramfs /bin/true" /etc/modprobe.d/; then
      echo "disabled"
      exit 0
    else
      echo "not_disabled"
      exit 1
    fi
  expected:
    type: string
    operator: "=="
    value: "disabled"
  timeout: 30
  retry: 2
  retry_delay: 3
  
remediation:
  type: command
  prerequisites:
    - root_access
  backup_before: true
  command: |
    # Create modprobe config to disable cramfs
    echo "install cramfs /bin/true" > /etc/modprobe.d/cramfs.conf
    echo "blacklist cramfs" >> /etc/modprobe.d/cramfs.conf
      
    # Unload module if currently loaded
    if lsmod | grep -q "^cramfs"; then
      rmmod cramfs 2>/dev/null || true
    fi
      
    # Update initramfs
    if command -v update-initramfs >/dev/null 2>&1; then
      update-initramfs -u
    elif command -v dracut >/dev/null 2>&1; then
      dracut -f
    fi
  requires_reboot: false
  timeout: 60
  verify_after: true
  verify_command: |
    if grep -Rq "^install cramfs /bin/true" /etc/modprobe.d/ && \
       ! lsmod | grep -q "^cramfs"; then
      exit 0
    else
      exit 1
    fi
  
rollback:
  enabled: true
  backup_location: "{{backup_dir}}/LNX-001_{{timestamp}}.backup"
  backup_command: |
    # Backup existing modprobe config if exists
    if [ -f /etc/modprobe.d/cramfs.conf ]; then
      cp /etc/modprobe.d/cramfs.conf "{{backup_location}}"
    else
      touch "{{backup_location}}"
    fi
  restore_command: |
    # Restore or remove the config file
    if [ -s "{{backup_location}}" ]; then
      cp "{{backup_location}}" /etc/modprobe.d/cramfs.conf
    else
      rm -f /etc/modprobe.d/cramfs.conf
    fi
      
    # Update initramfs
    if command -v update-initramfs >/dev/null 2>&1; then
      update-initramfs -u
    elif command -v dracut >/dev/null 2>&1; then
      dracut -f
    fi
  requires_reboot: false
  timeout: 60
  
logging:
  log_level: INFO
  log_category: filesystem_security
  audit_trail: true
  
reporting:
  report_section: Filesystem Configuration
  priority: medium
  remediation_complexity: low
  
tags:
  - filesystem
  - kernel
  - modules
  - cramfs
  - cis
  
notes: |
  This rule disables the cramfs kernel module to reduce attack surface.
  Part of a series of filesystem module hardening rules (LNX-001 through LNX-010).
