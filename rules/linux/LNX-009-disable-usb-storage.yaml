metadata:
  benchmark: CIS Linux Benchmarks v3.0.0
  os: linux
  distros:
    - ubuntu
    - debian
    - rhel
    - centos
    - fedora
  versions:
    ubuntu: ['20.04', '22.04', '24.04']
    debian: ['10', '11', '12']
    rhel: ['7', '8', '9']
    centos: ['7', '8', '9']
    fedora: ['36', '37', '38']

rule:
  id: LNX-009
  category: Filesystem
  subcategory: Kernel Modules
  description: Ensure usb-storage kernel module is not available
  severity: high
  
  audit:
    cis_reference: 1.1.1.9
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: USB storage provides a potential vector for data exfiltration and malware introduction. Disabling USB storage reduces the attack surface and prevents unauthorized data transfers.
    impact: USB storage devices will not be accessible. This may affect legitimate workflows that require USB storage.
  
  hardening_levels:
    basic:
      enabled: false
      value: enabled
    moderate:
      enabled: true
      value: disabled
    strict:
      enabled: true
      value: disabled
  
  check:
    type: command
    command: |
      if lsmod | grep -q "^usb_storage"; then
        echo "loaded"
        exit 1
      fi
      
      if modprobe -n -v usb_storage 2>&1 | grep -qv "install /bin/true"; then
        echo "available"
        exit 1
      fi
      
      if grep -Rq "^install usb-storage /bin/true" /etc/modprobe.d/; then
        echo "disabled"
        exit 0
      else
        echo "not_disabled"
        exit 1
      fi
    expected:
      type: string
      operator: "=="
      value: "{{hardening_value}}"
    timeout: 30
    retry: 2
    retry_delay: 3
  
  remediation:
    type: command
    prerequisites:
      - root_access
    backup_before: true
    warning: |
      WARNING: This will disable all USB storage devices. Ensure you have alternative access methods.
    confirmation_required: true
    command: |
      echo "install usb-storage /bin/true" > /etc/modprobe.d/usb-storage.conf
      echo "blacklist usb-storage" >> /etc/modprobe.d/usb-storage.conf
      
      if lsmod | grep -q "^usb_storage"; then
        rmmod usb_storage 2>/dev/null || true
      fi
      
      if command -v update-initramfs >/dev/null 2>&1; then
        update-initramfs -u
      elif command -v dracut >/dev/null 2>&1; then
        dracut -f
      fi
    requires_reboot: false
    timeout: 60
    verify_after: true
    verify_command: |
      if grep -Rq "^install usb-storage /bin/true" /etc/modprobe.d/ && \
         ! lsmod | grep -q "^usb_storage"; then
        exit 0
      else
        exit 1
      fi
  
  rollback:
    enabled: true
    backup_location: "{{backup_dir}}/LNX-009_{{timestamp}}.backup"
    backup_command: |
      if [ -f /etc/modprobe.d/usb-storage.conf ]; then
        cp /etc/modprobe.d/usb-storage.conf "{{backup_location}}"
      else
        touch "{{backup_location}}"
      fi
    restore_command: |
      if [ -s "{{backup_location}}" ]; then
        cp "{{backup_location}}" /etc/modprobe.d/usb-storage.conf
      else
        rm -f /etc/modprobe.d/usb-storage.conf
      fi
      
      if command -v update-initramfs >/dev/null 2>&1; then
        update-initramfs -u
      elif command -v dracut >/dev/null 2>&1; then
        dracut -f
      fi
    requires_reboot: false
    timeout: 60
  
  logging:
    log_level: WARNING
    log_category: filesystem_security
    audit_trail: true
  
  reporting:
    report_section: Filesystem Configuration
    priority: high
    remediation_complexity: low
  
  tags:
    - filesystem
    - kernel
    - modules
    - usb-storage
    - data-exfiltration
    - cis
  
  notes: |
    This rule disables USB storage to prevent data exfiltration.
    Consider the operational impact before applying this rule.
    Alternative: Use USB storage authorization tools instead of complete disable.
