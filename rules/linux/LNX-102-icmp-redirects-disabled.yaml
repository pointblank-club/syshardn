metadata:
  benchmark: CIS Linux Benchmarks v3.0.0
  os: linux
  distros:
    - ubuntu
    - debian
    - rhel
    - centos
    - fedora
  versions:
    ubuntu: ['20.04', '22.04', '24.04']
    debian: ['10', '11', '12']
    rhel: ['7', '8', '9']
    centos: ['7', '8', '9']
    fedora: ['36', '37', '38']

rule:
  id: LNX-102
  category: Network Configuration
  subcategory: ICMP
  description: Ensure ICMP redirects are not accepted
  severity: medium
  
  audit:
    cis_reference: 3.2.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: ICMP redirect messages are packets that convey routing information and tell your host to use an alternate gateway. Attackers can use ICMP redirect messages to alter your host's routing table, possibly redirecting traffic to a compromised machine.
    impact: Disabling ICMP redirects will prevent the system from being tricked into using malicious routes. This should not impact normal network operations.
  
  hardening_levels:
    basic:
      enabled: true
      value: 0
    moderate:
      enabled: true
      value: 0
    strict:
      enabled: true
      value: 0
  
check:
  type: command
  command: |
    all=$(sysctl -n net.ipv4.conf.all.accept_redirects)
    default=$(sysctl -n net.ipv4.conf.default.accept_redirects)
    if [ "$all" -eq "{{hardening_value}}" ] && [ "$default" -eq "{{hardening_value}}" ]; then
      echo "0"
    else
      echo "1"
    fi
  expected:
    type: number
    operator: "=="
    value: 0
  timeout: 10
  retry: 2
  retry_delay: 2
  
remediation:
  type: command
  prerequisites:
    - root_access
  backup_before: true
  command: |
    sysctl -w net.ipv4.conf.all.accept_redirects={{hardening_value}}
    sysctl -w net.ipv4.conf.default.accept_redirects={{hardening_value}}
    sysctl -w net.ipv4.conf.all.secure_redirects=0
    sysctl -w net.ipv4.conf.default.secure_redirects=0
    
    echo "net.ipv4.conf.all.accept_redirects = {{hardening_value}}" > /etc/sysctl.d/99-icmp-redirects.conf
    echo "net.ipv4.conf.default.accept_redirects = {{hardening_value}}" >> /etc/sysctl.d/99-icmp-redirects.conf
    echo "net.ipv4.conf.all.secure_redirects = 0" >> /etc/sysctl.d/99-icmp-redirects.conf
    echo "net.ipv4.conf.default.secure_redirects = 0" >> /etc/sysctl.d/99-icmp-redirects.conf
    
    for param in "net.ipv4.conf.all.accept_redirects" "net.ipv4.conf.default.accept_redirects" \
                 "net.ipv4.conf.all.secure_redirects" "net.ipv4.conf.default.secure_redirects"; do
      if grep -q "^$param" /etc/sysctl.conf; then
        sed -i "s/^$param.*/$param = 0/" /etc/sysctl.conf
      fi
    done
    
    sysctl -w net.ipv4.route.flush=1
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    all=$(sysctl -n net.ipv4.conf.all.accept_redirects)
    default=$(sysctl -n net.ipv4.conf.default.accept_redirects)
    if [ "$all" -eq "{{hardening_value}}" ] && [ "$default" -eq "{{hardening_value}}" ]; then
      exit 0
    else
      exit 1
    fi
  
rollback:
  enabled: true
  backup_location: "{{backup_dir}}/LNX-102_{{timestamp}}.backup"
  backup_command: |
    echo "net.ipv4.conf.all.accept_redirects=$(sysctl -n net.ipv4.conf.all.accept_redirects)" > "{{backup_location}}"
    echo "net.ipv4.conf.default.accept_redirects=$(sysctl -n net.ipv4.conf.default.accept_redirects)" >> "{{backup_location}}"
    echo "net.ipv4.conf.all.secure_redirects=$(sysctl -n net.ipv4.conf.all.secure_redirects)" >> "{{backup_location}}"
    echo "net.ipv4.conf.default.secure_redirects=$(sysctl -n net.ipv4.conf.default.secure_redirects)" >> "{{backup_location}}"
  restore_command: |
    if [ -f "{{backup_location}}" ]; then
      while IFS='=' read -r param value; do
        sysctl -w "$param=$value"
      done < "{{backup_location}}"
      
      rm -f /etc/sysctl.d/99-icmp-redirects.conf
      sysctl -w net.ipv4.route.flush=1
    fi
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: network_configuration
  audit_trail: true
  
reporting:
  report_section: Network Security
  priority: medium
  remediation_complexity: low
  
tags:
  - network
  - icmp
  - redirects
  - ipv4
  - cis
  
notes: |
  ICMP redirects can be used by attackers to alter routing tables.
  Disabling them prevents man-in-the-middle attacks via route manipulation.
  Both accept_redirects and secure_redirects should be disabled for complete protection.
