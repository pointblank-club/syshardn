metadata:
  benchmark: CIS Linux Benchmarks v3.0.0
  os: linux
  distros:
    - ubuntu
    - debian
    - rhel
    - centos
    - fedora
  versions:
    ubuntu: ['20.04', '22.04', '24.04']
    debian: ['10', '11', '12']
    rhel: ['7', '8', '9']
    centos: ['7', '8', '9']
    fedora: ['36', '37', '38']

rule:
  id: LNX-402
  category: User Accounts
  subcategory: System Accounts
  description: Ensure system accounts are secured
  severity: medium
  
  audit:
    cis_reference: 5.4.2.13
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: System accounts are used by services and should not be able to login directly. Accounts with UIDs less than 1000 (excluding root) should have nologin or false shells.
    impact: System accounts will not be able to login interactively.
  
  hardening_levels:
    basic:
      enabled: true
      value: "secured"
    moderate:
      enabled: true
      value: "secured"
    strict:
      enabled: true
      value: "secured"
  
check:
  type: command
  command: |
    # Check for system accounts (UID < 1000, not root) with valid shells
    valid_shells="/bin/bash|/bin/sh|/bin/zsh|/bin/ksh|/bin/fish"
    count=$(awk -F: '($3 < 1000 && $3 != 0 && $7 !~ /nologin|false/) { print $1":"$7 }' /etc/passwd | grep -E "$valid_shells" | wc -l)
    if [ "$count" -eq 0 ]; then
      echo "secured"
    else
      echo "vulnerable:$count"
    fi
  expected:
    type: string
    operator: "=="
    value: "secured"
  timeout: 10
  retry: 1
  retry_delay: 1
  
remediation:
  type: command
  prerequisites:
    - root_access
  backup_before: true
  command: |
    # Backup /etc/passwd
    cp /etc/passwd /etc/passwd.backup.$(date +%Y%m%d_%H%M%S)
      
    # Set nologin shell for system accounts
    for user in $(awk -F: '($3 < 1000 && $3 != 0 && $7 !~ /nologin|false/) { print $1 }' /etc/passwd); do
      echo "Securing system account: $user"
      usermod -s /usr/sbin/nologin "$user" 2>/dev/null || usermod -s /sbin/nologin "$user"
    done
      
    echo "System accounts secured"
  requires_reboot: false
  timeout: 60
  verify_after: true
  verify_command: |
    valid_shells="/bin/bash|/bin/sh|/bin/zsh|/bin/ksh|/bin/fish"
    count=$(awk -F: '($3 < 1000 && $3 != 0 && $7 !~ /nologin|false/) { print $1":"$7 }' /etc/passwd | grep -E "$valid_shells" | wc -l)
    if [ "$count" -eq 0 ]; then
      exit 0
    else
      exit 1
    fi
  
rollback:
  enabled: true
  backup_location: "{{backup_dir}}/LNX-402_{{timestamp}}.backup"
  backup_command: |
    cp /etc/passwd "{{backup_location}}"
  restore_command: |
    if [ -f "{{backup_location}}" ]; then
      cp "{{backup_location}}" /etc/passwd
    fi
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: user_account_security
  audit_trail: true
  
reporting:
  report_section: User Accounts and Environment
  priority: medium
  remediation_complexity: low
  
tags:
  - user_accounts
  - system_accounts
  - shells
  - cis
  
notes: |
  This rule ensures system accounts (UID < 1000) do not have valid login shells.
  System accounts are service accounts and should not be used for interactive login.
