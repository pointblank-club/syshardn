metadata:
  benchmark: CIS Linux Benchmarks v3.0.0
  os: linux
  distros:
    - ubuntu
    - debian
    - rhel
    - centos
    - fedora
  versions:
    ubuntu: ['20.04', '22.04', '24.04']
    debian: ['10', '11', '12']
    rhel: ['7', '8', '9']
    centos: ['7', '8', '9']
    fedora: ['36', '37', '38']

rule:
  id: LNX-503
  category: System File Permissions
  subcategory: Critical Files
  description: Ensure permissions on /etc/gshadow are configured (000 or 400)
  severity: critical
  
  audit:
    cis_reference: 6.1.5
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: The /etc/gshadow file contains secure group account information including group passwords. This file must have the most restrictive permissions possible. Only root should be able to read this file to prevent unauthorized access to group password hashes and group administrator information.
    impact: Setting strict permissions on /etc/gshadow ensures that sensitive group information cannot be accessed by unauthorized users. This is critical for system security and does not impact normal system operations.
  
  hardening_levels:
    basic:
      enabled: true
      value:
        permissions: "400"
        owner: "root"
        group: "root"
    moderate:
      enabled: true
      value:
        permissions: "000"
        owner: "root"
        group: "root"
    strict:
      enabled: true
      value:
        permissions: "000"
        owner: "root"
        group: "root"
  
check:
  type: command
  command: |
    if [ ! -f /etc/gshadow ]; then
      echo "0"
      exit 0
    fi
    
    perms=$(stat -c "%a" /etc/gshadow)
    owner=$(stat -c "%U" /etc/gshadow)
    group=$(stat -c "%G" /etc/gshadow)
    
    if [ "$perms" = "000" ] || [ "$perms" = "400" ]; then
      if [ "$owner" = "root" ]; then
        echo "0"
      else
        echo "1"
      fi
    else
      echo "1"
    fi
  expected:
    type: number
    operator: "=="
    value: 0
  timeout: 10
  retry: 2
  retry_delay: 2
  
remediation:
  type: command
  prerequisites:
    - root_access
  backup_before: true
  command: |
    if [ -f /etc/gshadow ]; then
      chmod {{hardening_value.permissions}} /etc/gshadow
      chown {{hardening_value.owner}}:{{hardening_value.group}} /etc/gshadow
    fi
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    if [ ! -f /etc/gshadow ]; then
      exit 0
    fi
    
    perms=$(stat -c "%a" /etc/gshadow)
    owner=$(stat -c "%U" /etc/gshadow)
    group=$(stat -c "%G" /etc/gshadow)
    
    if [ "$perms" = "{{hardening_value.permissions}}" ] && [ "$owner" = "{{hardening_value.owner}}" ] && [ "$group" = "{{hardening_value.group}}" ]; then
      exit 0
    else
      exit 1
    fi
  
rollback:
  enabled: true
  backup_location: "{{backup_dir}}/LNX-503_{{timestamp}}.backup"
  backup_command: |
    if [ -f /etc/gshadow ]; then
      stat -c "%a %U:%G" /etc/gshadow > "{{backup_location}}"
    else
      echo "not_exists" > "{{backup_location}}"
    fi
  restore_command: |
    if [ -f "{{backup_location}}" ]; then
      if grep -q "not_exists" "{{backup_location}}"; then
        exit 0
      fi
      
      perms=$(awk '{print $1}' "{{backup_location}}")
      owner=$(awk -F: '{print $1}' "{{backup_location}}" | awk '{print $2}')
      group=$(awk -F: '{print $2}' "{{backup_location}}")
      
      if [ -f /etc/gshadow ]; then
        chmod "$perms" /etc/gshadow
        chown "$owner:$group" /etc/gshadow
      fi
    fi
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: file_permissions
  audit_trail: true
  
reporting:
  report_section: File System Security
  priority: critical
  remediation_complexity: low
  
tags:
  - file-permissions
  - system-files
  - gshadow
  - group-security
  - access-control
  - cis
  
notes: |
  /etc/gshadow contains secure group information including group passwords.
  Permissions 000 (no access) or 400 (read-only for root) are acceptable.
  000 is more secure but 400 may be needed for some utilities.
  This file should never be readable by non-root users.
  Group ownership can be root or shadow depending on distribution.
  Some distributions may not use /etc/gshadow.
