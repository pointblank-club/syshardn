metadata:
  benchmark: CIS Linux Benchmarks v3.0.0
  os: linux
  distros:
    - ubuntu
    - debian
    - rhel
    - centos
    - fedora
  versions:
    ubuntu: ['20.04', '22.04', '24.04']
    debian: ['10', '11', '12']
    rhel: ['7', '8', '9']
    centos: ['7', '8', '9']
    fedora: ['36', '37', '38']

rule:
  id: LNX-800
  category: Privilege Escalation
  subcategory: sudo Configuration
  description: Ensure sudo commands use pty
  severity: high
  
  audit:
    cis_reference: 5.3.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: Attackers can run malicious programs using sudo that would allow them to fork a background process that remains even when the main program has finished executing. Requiring sudo to run in a pseudo-terminal (pty) helps prevent this attack vector. The use_pty option prevents this behavior by requiring all sudo commands to run from a pty.
    impact: All sudo commands will be required to run from a pseudo-terminal. This should not impact normal sudo operations but will prevent certain types of background process attacks.
  
  hardening_levels:
    basic:
      enabled: true
      value: use_pty
    moderate:
      enabled: true
      value: use_pty
    strict:
      enabled: true
      value: use_pty
  
check:
  type: command
  command: |
    if grep -rEq '^\s*Defaults\s+([^#]+,\s*)?use_pty(,\s*\S+\s*)*(\s+#.*)?$' /etc/sudoers /etc/sudoers.d/ 2>/dev/null; then
      echo "0"
    else
      echo "1"
    fi
  expected:
    type: number
    operator: "=="
    value: 0
  timeout: 10
  retry: 2
  retry_delay: 2
  
remediation:
  type: command
  prerequisites:
    - root_access
  backup_before: true
  command: |
    if ! grep -rEq '^\s*Defaults\s+([^#]+,\s*)?use_pty' /etc/sudoers /etc/sudoers.d/ 2>/dev/null; then
      echo "Defaults {{hardening_value}}" >> /etc/sudoers.d/99-use-pty
      chmod 0440 /etc/sudoers.d/99-use-pty
    fi
    
    visudo -c -f /etc/sudoers.d/99-use-pty
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    if grep -rEq '^\s*Defaults\s+([^#]+,\s*)?use_pty' /etc/sudoers /etc/sudoers.d/ 2>/dev/null; then
      visudo -c -f /etc/sudoers.d/99-use-pty >/dev/null 2>&1
      exit $?
    else
      exit 1
    fi
  
rollback:
  enabled: true
  backup_location: "{{backup_dir}}/LNX-800_{{timestamp}}.backup"
  backup_command: |
    if grep -rEq '^\s*Defaults\s+([^#]+,\s*)?use_pty' /etc/sudoers /etc/sudoers.d/ 2>/dev/null; then
      echo "configured" > "{{backup_location}}"
      grep -rE '^\s*Defaults\s+([^#]+,\s*)?use_pty' /etc/sudoers /etc/sudoers.d/ 2>/dev/null >> "{{backup_location}}"
    else
      echo "not-configured" > "{{backup_location}}"
    fi
  restore_command: |
    if [ -f "{{backup_location}}" ]; then
      status=$(head -n 1 "{{backup_location}}")
      if [ "$status" = "not-configured" ]; then
        rm -f /etc/sudoers.d/99-use-pty
      fi
    fi
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: privilege_escalation
  audit_trail: true
  
reporting:
  report_section: Privilege Escalation Security
  priority: high
  remediation_complexity: low
  
tags:
  - sudo
  - privilege-escalation
  - pty
  - security-hardening
  - cis
  
notes: |
  The use_pty option requires all sudo commands to run in a pseudo-terminal.
  This prevents attackers from running background processes that persist after sudo exits.
  Configuration is added to /etc/sudoers.d/99-use-pty for modularity.
  The visudo command is used to validate the configuration syntax.
  This is a critical security hardening measure for sudo.
