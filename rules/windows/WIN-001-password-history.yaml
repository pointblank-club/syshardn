metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-001
  category: Account Policies
  subcategory: Password Policy
  description: Ensure 'Enforce password history' is set to '24 or more password(s)'
  severity: medium
  
  audit:
    cis_reference: 1.1.1
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
    rationale: The Enforce password history policy setting determines the number of unique new passwords that have to be associated with a user account before an old password can be reused.
    impact: Users will be unable to reuse any of their previous 24 passwords
  
  hardening_levels:
    basic:
      enabled: true
      value: 12
    moderate:
      enabled: true
      value: 18
    strict:
      enabled: true
      value: 24
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
        $tempFile = [System.IO.Path]::GetTempFileName()
        $null = secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet
        Start-Sleep -Milliseconds 500
        $content = Get-Content $tempFile -ErrorAction Stop
        Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue
        $line = $content | Select-String "PasswordHistorySize"
        if ($line) {
            $value = $line.ToString().Split('=')[1].Trim()
            Write-Output $value
        } else {
            Write-Output "0"
        }
    } catch {
        Write-Output "0"
    }
  expected:
    type: number
    operator: '>='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: '$tempFile = [System.IO.Path]::GetTempFileName()

    "[System Access]`nPasswordHistorySize = {{hardening_value}}" | Out-File -FilePath
    $tempFile -Encoding ASCII

    secedit /configure /db secedit.sdb /cfg $tempFile /areas SECURITYPOLICY /quiet

    Remove-Item -Path $tempFile -Force

    '
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
        $tempFile = [System.IO.Path]::GetTempFileName()
        $null = secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet
        Start-Sleep -Seconds 1
        $content = Get-Content $tempFile -ErrorAction Stop
        Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue
        $line = $content | Select-String "PasswordHistorySize"
        if ($line) {
            $value = [int]($line.ToString().Split('=')[1].Trim())
            if ($value -ge {{hardening_value}}) { 
                Write-Output "Verified: PasswordHistorySize = $value"
                exit 0 
            } else { 
                Write-Error "Current value $value is less than required {{hardening_value}}"
                exit 1 
            }
        } else {
            Write-Error "PasswordHistorySize not found in security policy"
            exit 1
        }
    } catch {
        Write-Error "Verification failed: $_"
        exit 1
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-001_{{timestamp}}.cfg'
  backup_command: 'secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY
    /quiet

    '
  restore_command: 'secedit /configure /db secedit.sdb /cfg "{{backup_location}}"
    /areas SECURITYPOLICY /quiet

    '
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: password_policy
  audit_trail: true
  
reporting:
  report_section: Account Policies
  priority: high
  remediation_complexity: low
  
tags:
  - password
  - policy
  - history
  - cis
  
notes: |
  Configure with WIN-002 (Minimum password age) to prevent password cycling.
