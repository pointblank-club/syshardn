metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-002
  category: Account Policies
  subcategory: Password Policy
  description: Ensure 'Maximum password age' is set to '90 days, but not 0'
  severity: medium
  
  audit:
    cis_reference: 1.1.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: The Maximum password age policy setting determines the period of time (in days) that a password can be used before the system requires the user to change it. Passwords should be changed regularly to prevent unauthorized access from compromised credentials.
    impact: Users will be required to change their passwords at the specified interval. Setting this too short may frustrate users and lead to poor password practices.
  
  hardening_levels:
    basic:
      enabled: true
      value: 90
    moderate:
      enabled: true
      value: 60
    strict:
      enabled: true
      value: 45
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    $raw = net accounts | Select-String 'Maximum password age'
    if (-not $raw) {
      Write-Output '0'
      return
    }
    $value = ($raw.ToString() -split ':')[1].Trim()
    if ($value -match 'Never') {
      Write-Output '0'
      return
    }
    $days = $value -replace '[^\d]', ''
    if ([string]::IsNullOrWhiteSpace($days)) {
      Write-Output '0'
      return
    }
    Write-Output $days
  expected:
    type: number
    operator: <=
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    $tempFile = [System.IO.Path]::GetTempFileName()
    try {
      "[System Access]`nMaximumPasswordAge = {{hardening_value}}" |
        Out-File -FilePath $tempFile -Encoding ASCII
      $proc = Start-Process -FilePath secedit -ArgumentList @(
        '/configure','/db','secedit.sdb','/cfg',$tempFile,'/areas','SECURITYPOLICY','/quiet'
      ) -NoNewWindow -Wait -PassThru
      if ($proc.ExitCode -ne 0) {
        throw "secedit exited with code $($proc.ExitCode)"
      }
    }
    finally {
      Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    $raw = net accounts | Select-String 'Maximum password age'
    if (-not $raw) { exit 1 }
    $value = ($raw.ToString() -split ':')[1].Trim()
    if ($value -match 'Never') { exit 1 }
    $days = $value -replace '[^\d]', ''
    if ([string]::IsNullOrWhiteSpace($days)) { exit 1 }
    if ([int]$days -le {{hardening_value}} -and [int]$days -ne 0) { exit 0 } else { exit 1 }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-002_{{timestamp}}.cfg'
  backup_command: 'secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY
    /quiet

    '
  restore_command: 'secedit /configure /db secedit.sdb /cfg "{{backup_location}}"
    /areas SECURITYPOLICY /quiet

    '
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: password_policy
  audit_trail: true
  
reporting:
  report_section: Account Policies
  priority: high
  remediation_complexity: low
  
tags:
  - password
  - policy
  - age
  - cis
  
notes: |
  Works with WIN-001 and WIN-003 to prevent password reuse. Must be greater than 0.
