metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-002
  category: Account Policies
  subcategory: Password Policy
  description: Ensure 'Maximum password age' is set to '90 days, but not 0'
  severity: medium
  
  audit:
    cis_reference: 1.1.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: The Maximum password age policy setting determines the period of time (in days) that a password can be used before the system requires the user to change it. Passwords should be changed regularly to prevent unauthorized access from compromised credentials.
    impact: Users will be required to change their passwords at the specified interval. Setting this too short may frustrate users and lead to poor password practices.
  
  hardening_levels:
    basic:
      enabled: true
      value: 90
    moderate:
      enabled: true
      value: 60
    strict:
      enabled: true
      value: 45
  
  check:
    type: command
    command: |
      $maxAge = (net accounts | Select-String "Maximum password age" | ForEach-Object { ($_ -split ":")[1].Trim() -replace '\D+','' })
      Write-Output $maxAge
    expected:
      type: number
      operator: "<="
      value: "{{hardening_value}}"
    timeout: 30
    retry: 2
    retry_delay: 5
  
  remediation:
    type: command
    prerequisites:
      - admin_rights
    backup_before: true
    command: |
      $tempFile = [System.IO.Path]::GetTempFileName()
      "[System Access]`nMaximumPasswordAge = {{hardening_value}}" | Out-File -FilePath $tempFile -Encoding ASCII
      secedit /configure /db secedit.sdb /cfg $tempFile /areas SECURITYPOLICY /quiet
      Remove-Item -Path $tempFile -Force
    requires_reboot: false
    timeout: 30
    verify_after: true
    verify_command: |
      $maxAge = (net accounts | Select-String "Maximum password age" | ForEach-Object { ($_ -split ":")[1].Trim() -replace '\D+','' })
      if ([int]$maxAge -le {{hardening_value}} -and [int]$maxAge -ne 0) { exit 0 } else { exit 1 }
  
  rollback:
    enabled: true
    backup_location: "{{backup_dir}}/WIN-002_{{timestamp}}.cfg"
    backup_command: |
      secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY /quiet
    restore_command: |
      secedit /configure /db secedit.sdb /cfg "{{backup_location}}" /areas SECURITYPOLICY /quiet
    requires_reboot: false
    timeout: 30
  
  logging:
    log_level: INFO
    log_category: password_policy
    audit_trail: true
  
  reporting:
    report_section: Account Policies
    priority: high
    remediation_complexity: low
  
  tags:
    - password
    - policy
    - age
    - cis
  
  notes: |
    This setting works with WIN-001 (password history) and WIN-003 (minimum password age) to prevent password reuse.
    Must be greater than 0 and should not be set to unlimited.
    Recommended: 45-90 days depending on security requirements.
