metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-005
  category: Account Policies
  subcategory: Password Policy
  description: Ensure 'Password must meet complexity requirements' is set to 'Enabled'
  severity: high

  audit:
    cis_reference: 1.1.5
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
      - HIPAA
    rationale: Password complexity requirements significantly increase the difficulty of password guessing attacks. Complex passwords that use a combination of uppercase, lowercase, numbers, and special characters are much more resistant to brute force and dictionary attacks.
    impact: Users must create passwords that contain characters from at least three of the following categories - uppercase letters, lowercase letters, numbers, and special characters. Simple passwords like "password123" will no longer be accepted.
  
  hardening_levels:
    basic:
      enabled: true
      value: 1
    moderate:
      enabled: true
      value: 1
    strict:
      enabled: true
      value: 1
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    $tempFile = Join-Path $env:TEMP ("secpol_{0}.cfg" -f [guid]::NewGuid())
    secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet | Out-Null
    try {
      $line = Get-Content -Path $tempFile | Where-Object { $_ -match 'PasswordComplexity' } | Select-Object -First 1
      if (-not $line) {
        throw 'PasswordComplexity setting not found in security policy export.'
      }
      $valueText = $line.Split('=')[1].Trim()
      $numeric = $valueText -replace '[^0-9]'
      if (-not $numeric) {
        throw "PasswordComplexity value '${valueText}' is not numeric."
      }
      $value = [int]$numeric
      Write-Output $value
    }
    finally {
      if (Test-Path $tempFile) {
        Remove-Item $tempFile -Force
      }
    }
  expected:
    type: number
    operator: ==
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    $tempFile = Join-Path $env:TEMP ("secpol_{0}.cfg" -f [guid]::NewGuid())
    secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet | Out-Null
    try {
      $content = Get-Content -Path $tempFile
      if (-not ($content | Where-Object { $_ -match '^PasswordComplexity' })) {
        throw 'PasswordComplexity entry not found in exported security policy.'
      }
      $content | ForEach-Object {
        if ($_ -match '^PasswordComplexity') {
          "PasswordComplexity = {{hardening_value}}"
        } else {
          $_
        }
      } | Set-Content -Path $tempFile -Encoding ASCII
      secedit /configure /db secedit.sdb /cfg $tempFile /areas SECURITYPOLICY /quiet | Out-Null
    }
    finally {
      if (Test-Path $tempFile) {
        Remove-Item -Path $tempFile -Force
      }
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    $tempFile = Join-Path $env:TEMP ("secpol_{0}.cfg" -f [guid]::NewGuid())
    secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet | Out-Null
    try {
      $line = Get-Content -Path $tempFile | Where-Object { $_ -match 'PasswordComplexity' } | Select-Object -First 1
      if (-not $line) {
        exit 1
      }
      $valueText = $line.Split('=')[1].Trim()
      $numeric = $valueText -replace '[^0-9]'
      if (-not $numeric) {
        exit 1
      }
      $value = [int]$numeric
      $expected = [int]"{{hardening_value}}"
      if ($value -eq $expected) {
        exit 0
      } else {
        exit 1
      }
    }
    finally {
      if (Test-Path $tempFile) {
        Remove-Item $tempFile -Force
      }
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-005_{{timestamp}}.cfg'
  backup_command: 'secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY
    /quiet

    '
  restore_command: 'secedit /configure /db secedit.sdb /cfg "{{backup_location}}"
    /areas SECURITYPOLICY /quiet

    '
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: WARNING
  log_category: password_policy
  audit_trail: true
  
reporting:
  report_section: Account Policies
  priority: critical
  remediation_complexity: low
  
tags:
  - password
  - policy
  - complexity
  - cis
  - critical
  
notes: |
  Prevents weak passwords. Requires 3 of 4 character types (uppercase, lowercase, numbers, special). Combine with WIN-004.
