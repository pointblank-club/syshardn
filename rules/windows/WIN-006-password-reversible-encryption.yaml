metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-006
  category: Account Policies
  subcategory: Password Policy
  description: Ensure 'Store passwords using reversible encryption' is set to 'Disabled'
  severity: critical
  
  audit:
    cis_reference: 1.1.6
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
      - HIPAA
      - SOC 2
    rationale: Storing passwords using reversible encryption is essentially the same as storing plaintext versions of the passwords. If reversible encryption is enabled, an attacker who gains access to the password database can easily decrypt and use the passwords. This setting should always be disabled.
    impact: Some applications that require knowledge of the user's password for authentication purposes may no longer work. CHAP authentication and Digest Authentication in IIS require this setting, but these should be replaced with more secure authentication methods.
  
  hardening_levels:
    basic:
      enabled: true
      value: 0
    moderate:
      enabled: true
      value: 0
    strict:
      enabled: true
      value: 0
  
  check:
    type: command
    command: |
      $reversible = (secedit /export /cfg "$env:TEMP\secpol.cfg" /quiet) | Out-Null
      $value = (Get-Content "$env:TEMP\secpol.cfg" | Select-String "ClearTextPassword").ToString().Split('=')[1].Trim()
      Remove-Item "$env:TEMP\secpol.cfg" -Force
      Write-Output $value
    expected:
      type: number
      operator: "=="
      value: "{{hardening_value}}"
    timeout: 30
    retry: 2
    retry_delay: 5
  
  remediation:
    type: command
    prerequisites:
      - admin_rights
    backup_before: true
    warning: |
      WARNING: Disabling reversible encryption may break legacy applications that require it.
      Ensure all applications use secure authentication methods before applying this setting.
    command: |
      $tempFile = [System.IO.Path]::GetTempFileName()
      "[System Access]`nClearTextPassword = {{hardening_value}}" | Out-File -FilePath $tempFile -Encoding ASCII
      secedit /configure /db secedit.sdb /cfg $tempFile /areas SECURITYPOLICY /quiet
      Remove-Item -Path $tempFile -Force
    requires_reboot: false
    timeout: 30
    verify_after: true
    verify_command: |
      $reversible = (secedit /export /cfg "$env:TEMP\secpol.cfg" /quiet) | Out-Null
      $value = (Get-Content "$env:TEMP\secpol.cfg" | Select-String "ClearTextPassword").ToString().Split('=')[1].Trim()
      Remove-Item "$env:TEMP\secpol.cfg" -Force
      if ([int]$value -eq {{hardening_value}}) { exit 0 } else { exit 1 }
  
  rollback:
    enabled: true
    backup_location: "{{backup_dir}}/WIN-006_{{timestamp}}.cfg"
    backup_command: |
      secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY /quiet
    restore_command: |
      secedit /configure /db secedit.sdb /cfg "{{backup_location}}" /areas SECURITYPOLICY /quiet
    requires_reboot: false
    timeout: 30
  
  logging:
    log_level: CRITICAL
    log_category: password_policy
    audit_trail: true
  
  reporting:
    report_section: Account Policies
    priority: critical
    remediation_complexity: low
  
  tags:
    - password
    - policy
    - encryption
    - cis
    - critical
    - security
  
  notes: |
    CRITICAL: This should ALWAYS be disabled (set to 0).
    
    Reversible encryption is equivalent to storing passwords in plaintext.
    Only enable if absolutely required by legacy applications, and plan migration immediately.
    
    Applications that may require this (all deprecated):
    - CHAP authentication through Remote Access or IAS
    - Digest Authentication in IIS
    
    Modern alternatives:
    - Use Kerberos or NTLM v2 instead of CHAP
    - Use Windows Authentication or OAuth instead of Digest Auth
    - Consider implementing MFA for additional security
    
    If this must be enabled:
    - Document the business justification
    - Create a migration plan to eliminate the requirement
    - Implement additional compensating controls
    - Enable enhanced monitoring for those accounts
