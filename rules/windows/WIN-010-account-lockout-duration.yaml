metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-010
  category: Account Policies
  subcategory: Account Lockout Policy
  description: Ensure 'Account lockout duration' is set to '15 or more minute(s)'
  severity: medium

  audit:
    cis_reference: 1.2.1
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: Account lockout duration determines the number of minutes a locked-out
      account remains locked before automatically becoming unlocked. A lockout duration
      of at least 15 minutes provides protection against brute-force password guessing
      attacks while not creating excessive user frustration.
    impact: User accounts will be locked for the specified duration after exceeding
      the lockout threshold. This may result in help desk calls if users forget they
      are locked out. Administrators can manually unlock accounts if needed.
  hardening_levels:
    basic:
      enabled: true
      value: 15
    moderate:
      enabled: true
      value: 30
    strict:
      enabled: true
      value: 60
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
        $tempFile = [System.IO.Path]::GetTempFileName()
        $null = secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet
        Start-Sleep -Milliseconds 500
        $content = Get-Content $tempFile -ErrorAction Stop
        Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue
        $line = $content | Select-String "^LockoutDuration"
        if ($line) {
            $value = $line.ToString().Split('=')[1].Trim()
            Write-Output $value
        } else {
            Write-Output "0"
        }
    } catch {
        Write-Output "0"
    }
  expected:
    type: number
    operator: '>='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: '$tempFile = [System.IO.Path]::GetTempFileName()

    "[System Access]`nLockoutDuration = {{hardening_value}}" | Out-File -FilePath
    $tempFile -Encoding ASCII

    secedit /configure /db secedit.sdb /cfg $tempFile /areas SECURITYPOLICY /quiet

    Remove-Item -Path $tempFile -Force

    '
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
        $tempFile = [System.IO.Path]::GetTempFileName()
        $null = secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet
        Start-Sleep -Seconds 1
        $content = Get-Content $tempFile -ErrorAction Stop
        Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue
        $line = $content | Select-String "^LockoutDuration"
        if ($line) {
            $value = [int]($line.ToString().Split('=')[1].Trim())
            if ($value -ge {{hardening_value}}) { 
                Write-Output "Verified: LockoutDuration = $value"
                exit 0 
            } else { 
                Write-Error "Current value $value is less than required {{hardening_value}}"
                exit 1 
            }
        } else {
            Write-Error "LockoutDuration not found in security policy"
            exit 1
        }
    } catch {
        Write-Error "Verification failed: $_"
        exit 1
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-010_{{timestamp}}.cfg'
  backup_command: 'secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY
    /quiet

    '
  restore_command: 'secedit /configure /db secedit.sdb /cfg "{{backup_location}}"
    /areas SECURITYPOLICY /quiet

    '
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: account_lockout
  audit_trail: true
  
reporting:
  report_section: Account Policies
  priority: medium
  remediation_complexity: low
  
tags:
  - account
  - lockout
  - policy
  - cis
  - brute-force

notes: |
  Works with WIN-011 (threshold) and WIN-012 (admin lockout). Balance security with usability.
