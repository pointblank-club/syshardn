metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-011
  category: Account Policies
  subcategory: Account Lockout Policy
  description: Ensure 'Account lockout threshold' is set to '5 or fewer invalid logon
    attempt(s), but not 0'
  severity: high

  audit:
    cis_reference: 1.2.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
      - HIPAA
    rationale: Account lockout threshold determines the number of failed logon attempts
      that causes a user account to be locked. Setting a threshold reduces the likelihood
      of successful brute-force attacks while balancing against user productivity
      and help desk workload.
    impact: User accounts will be locked after the specified number of failed logon
      attempts. This may increase help desk calls but significantly improves security
      against password attacks. Setting to 0 disables lockout (not recommended).
  hardening_levels:
    basic:
      enabled: true
      value: 5
    moderate:
      enabled: true
      value: 4
    strict:
      enabled: true
      value: 3
  
check:
  type: command
  command: '$ErrorActionPreference = ''Stop''; try { $tempFile = [System.IO.Path]::GetTempFileName(); $null = secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet; Start-Sleep -Milliseconds 500; $content = Get-Content $tempFile -ErrorAction Stop; Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue; $line = $content | Select-String "^LockoutBadCount"; if ($line) { $value = $line.ToString().Split(''='')[1].Trim(); Write-Output $value } else { Write-Output "0" } } catch { Write-Output "0" }'
  expected:
    type: number
    operator: '<='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5

remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: '$tempFile = [System.IO.Path]::GetTempFileName()

    "[System Access]`nLockoutBadCount = {{hardening_value}}" | Out-File -FilePath
    $tempFile -Encoding ASCII

    secedit /configure /db secedit.sdb /cfg $tempFile /areas SECURITYPOLICY /quiet

    Remove-Item -Path $tempFile -Force

    '
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: '$ErrorActionPreference = ''Stop''; try { $tempFile = [System.IO.Path]::GetTempFileName(); $null = secedit /export /cfg $tempFile /areas SECURITYPOLICY /quiet; Start-Sleep -Seconds 1; $content = Get-Content $tempFile -ErrorAction Stop; Remove-Item -Path $tempFile -Force -ErrorAction SilentlyContinue; $line = $content | Select-String "^LockoutBadCount"; if ($line) { $value = [int]($line.ToString().Split(''='')[1].Trim()); if ($value -le {{hardening_value}} -and $value -ne 0) { Write-Output "Verified: LockoutBadCount = $value"; exit 0 } else { Write-Error "Current value $value does not meet requirement (should be <= {{hardening_value}} and not 0)"; exit 1 } } else { Write-Error "LockoutBadCount not found in security policy"; exit 1 } } catch { Write-Error "Verification failed: $_"; exit 1 }'
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-011_{{timestamp}}.cfg'
  backup_command: 'secedit /export /cfg "{{backup_location}}" /areas SECURITYPOLICY
    /quiet

    '
  restore_command: 'secedit /configure /db secedit.sdb /cfg "{{backup_location}}"
    /areas SECURITYPOLICY /quiet

    '
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: WARNING
  log_category: account_lockout
  audit_trail: true
  
reporting:
  report_section: Account Policies
  priority: high
  remediation_complexity: low
  
tags:
  - account
  - lockout
  - policy
  - threshold
  - cis
  - brute-force
  - critical

notes: |
  Critical brute-force protection. Works with WIN-010 and WIN-012. NEVER set to 0. Monitor Event IDs 4740/4625.
