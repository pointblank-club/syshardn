metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-012
  category: Account Policies
  subcategory: Account Lockout Policy
  description: Ensure 'Allow Administrator account lockout' is set to 'Enabled' (Manual)
  severity: high

  audit:
    cis_reference: 1.2.3
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: Historically, the built-in Administrator account could not be locked
      out regardless of the number of failed logon attempts. This made it a prime
      target for brute-force attacks. Enabling administrator account lockout significantly
      improves security by preventing unlimited password guessing attempts.
    impact: The built-in Administrator account can be locked out after failed logon
      attempts. Ensure you have an alternative administrative access method (another
      admin account, physical access, recovery media) before enabling this setting.
  hardening_levels:
    basic:
      enabled: false
      value: 0
    moderate:
      enabled: true
      value: 1
    strict:
      enabled: true
      value: 1
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
    $value = (Get-ItemProperty -Path $regPath -Name 'AllowAdministratorLockout' -ErrorAction SilentlyContinue).AllowAdministratorLockout
    if ($null -eq $value) {
      Write-Output '0'
      return
    }
    Write-Output $value
  expected:
    type: number
    operator: ==
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  warning: 'CRITICAL WARNING: Enabling this setting can lock out the built-in Administrator
    account.


    Before proceeding, ensure you have:

    1. At least one other administrator account that works

    2. Physical access to the system or remote management capability

    3. A recovery plan if lockout occurs

    4. Documented the administrator password securely


    Consider creating a "break-glass" administrator account for emergency access.

    '
  confirmation_required: true
  command: |
    $ErrorActionPreference = 'Stop'
    $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
    if (!(Test-Path $regPath)) {
      New-Item -Path $regPath -Force | Out-Null
    }
    Set-ItemProperty -Path $regPath -Name 'AllowAdministratorLockout' -Value {{hardening_value}} -Type DWord
    Write-Output 'Administrator account lockout has been configured'
  requires_reboot: true
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
    $value = (Get-ItemProperty -Path $regPath -Name 'AllowAdministratorLockout' -ErrorAction SilentlyContinue).AllowAdministratorLockout
    if ($null -ne $value -and [int]$value -eq {{hardening_value}}) { exit 0 } else { exit 1 }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-012_{{timestamp}}.reg'
  backup_command: '# Export the registry key

    reg export "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" "{{backup_location}}" /y

    '
  restore_command: '# Restore the registry key

    reg import "{{backup_location}}"

    '
  requires_reboot: true
  timeout: 30
  
logging:
  log_level: CRITICAL
  log_category: account_lockout
  audit_trail: true
  
reporting:
  report_section: Account Policies
  priority: critical
  remediation_complexity: high
  
tags:
  - account
  - lockout
  - administrator
  - policy
  - cis
  - critical
  - high-risk

notes: |
  CRITICAL: Manual review required. Works with WIN-010/011. Create alternate admin account before enabling. Requires reboot.
