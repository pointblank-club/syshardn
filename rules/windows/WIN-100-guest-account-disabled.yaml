metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-100
  category: Local Policies
  subcategory: Security Options - Accounts
  description: "Ensure 'Accounts: Guest account status' is set to 'Disabled'"
  severity: high
  
  audit:
    cis_reference: 2.3.1.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: The Guest account allows unauthenticated network users to gain access to the system. Disabling the Guest account helps prevent unauthorized access to the system and network resources.
    impact: Guest account will be disabled and cannot be used for logon. This should not impact legitimate users who have proper user accounts.
  
  hardening_levels:
    basic:
      enabled: true
      value: disabled
    moderate:
      enabled: true
      value: disabled
    strict:
      enabled: true
      value: disabled
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      $guest = Get-LocalUser -Name 'Guest' -ErrorAction Stop
      if ($guest.Enabled) {
        Write-Output 'enabled'
      } else {
        Write-Output 'disabled'
      }
    } catch {
      Write-Output 'disabled'
    }
  expected:
    type: string
    operator: '=='
    value: 'disabled'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      Disable-LocalUser -Name 'Guest' -ErrorAction Stop
    } catch {
      Write-Error "Failed to disable Guest account: $_"
      exit 1
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $guest = Get-LocalUser -Name 'Guest' -ErrorAction Stop
      if ($guest.Enabled) {
        exit 1
      } else {
        exit 0
      }
    } catch {
      exit 0
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-100_{{timestamp}}.txt'
  backup_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $guest = Get-LocalUser -Name 'Guest' -ErrorAction Stop
      $guest.Enabled | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
    } catch {
      'False' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
    }
  restore_command: |
    $ErrorActionPreference = 'Stop'
    if (Test-Path '{{backup_location}}') {
      $wasEnabled = Get-Content '{{backup_location}}' | Select-Object -First 1
      if ($wasEnabled -eq 'True') {
        try {
          Enable-LocalUser -Name 'Guest' -ErrorAction Stop
        } catch {
          Write-Warning "Failed to restore Guest account: $_"
        }
      }
    }
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: local_policies
  audit_trail: true
  
reporting:
  report_section: Security Options
  priority: high
  remediation_complexity: low
  
tags:
  - security-options
  - guest-account
  - access-control
  - accounts
  - cis
  
notes: |
  The Guest account provides a way for unauthenticated users to log on to the system.
  It should always be disabled to prevent unauthorized access.
  This is a critical security control for all Windows systems.
