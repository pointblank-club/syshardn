metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-110
  category: Local Policies
  subcategory: Security Options - Interactive Logon
  description: Ensure 'Interactive logon: Do not require CTRL+ALT+DEL' is set to 'Disabled'
  severity: medium
  
  audit:
    cis_reference: 2.3.7.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: Requiring CTRL+ALT+DEL before users log on ensures that users are communicating with the trusted Windows logon screen. This helps protect against Trojan horse programs that might attempt to intercept user passwords.
    impact: Users will be required to press CTRL+ALT+DEL before logging on to Windows. This is standard behavior and should not negatively impact users.
  
  hardening_levels:
    basic:
      enabled: true
      value: 0
    moderate:
      enabled: true
      value: 0
    strict:
      enabled: true
      value: 0
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'DisableCAD'
      if (Test-Path $regPath) {
        $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
        if ($null -eq $value) {
          Write-Output 0
        } else {
          Write-Output $value
        }
      } else {
        Write-Output 0
      }
    } catch {
      Write-Output 0
    }
  expected:
    type: number
    operator: '=='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
    $regName = 'DisableCAD'
    try {
      if (-not (Test-Path $regPath)) {
        New-Item -Path $regPath -Force | Out-Null
      }
      Set-ItemProperty -Path $regPath -Name $regName -Value {{hardening_value}} -Type DWord -Force
    } catch {
      Write-Error "Failed to set registry value: $_"
      exit 1
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'DisableCAD'
      $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction Stop | Select-Object -ExpandProperty $regName
      $expected = [int]"{{hardening_value}}"
      if ($value -eq $expected) { exit 0 } else { exit 1 }
    } catch {
      exit 1
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-110_{{timestamp}}.txt'
  backup_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'DisableCAD'
      $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
      if ($null -eq $value) {
        'NotSet' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      } else {
        $value | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      }
    } catch {
      'NotSet' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
    }
  restore_command: |
    $ErrorActionPreference = 'Stop'
    if (Test-Path '{{backup_location}}') {
      $oldValue = Get-Content '{{backup_location}}' | Select-Object -First 1
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'DisableCAD'
      try {
        if ($oldValue -eq 'NotSet') {
          Remove-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
        } else {
          Set-ItemProperty -Path $regPath -Name $regName -Value ([int]$oldValue) -Type DWord -Force
        }
      } catch {
        Write-Warning "Failed to restore registry value: $_"
      }
    }
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: local_policies
  audit_trail: true
  
reporting:
  report_section: Security Options
  priority: medium
  remediation_complexity: low
  
tags:
  - security-options
  - interactive-logon
  - secure-attention-sequence
  - ctrl-alt-del
  - cis
  
notes: |
  DisableCAD = 0 means CTRL+ALT+DEL is required (secure).
  DisableCAD = 1 means CTRL+ALT+DEL is NOT required (insecure).
  Requiring CTRL+ALT+DEL protects against credential-stealing malware.
  This is the Secure Attention Sequence (SAS) in Windows.
