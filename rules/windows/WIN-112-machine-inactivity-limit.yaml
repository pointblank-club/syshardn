metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-112
  category: Local Policies
  subcategory: Security Options - Interactive Logon
  description: "Ensure 'Interactive logon: Machine inactivity limit' is set to '900 or fewer seconds'"
  severity: medium
  
  audit:
    cis_reference: 2.3.7.4
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: Setting a machine inactivity timeout ensures that unattended workstations will automatically lock after a period of inactivity, reducing the risk of unauthorized access to an unattended system.
    impact: The machine will automatically lock after the specified period of inactivity. Users will need to re-authenticate to access the system. 900 seconds equals 15 minutes.
  
  hardening_levels:
    basic:
      enabled: true
      value: 900
    moderate:
      enabled: true
      value: 600
    strict:
      enabled: true
      value: 300
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'InactivityTimeoutSecs'
      if (Test-Path $regPath) {
        $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
        if ($null -eq $value) {
          Write-Output 0
        } else {
          Write-Output $value
        }
      } else {
        Write-Output 0
      }
    } catch {
      Write-Output 0
    }
  expected:
    type: number
    operator: '<='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
    $regName = 'InactivityTimeoutSecs'
    try {
      if (-not (Test-Path $regPath)) {
        New-Item -Path $regPath -Force | Out-Null
      }
      Set-ItemProperty -Path $regPath -Name $regName -Value {{hardening_value}} -Type DWord -Force
    } catch {
      Write-Error "Failed to set registry value: $_"
      exit 1
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'InactivityTimeoutSecs'
      $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction Stop | Select-Object -ExpandProperty $regName
      $expected = [int]"{{hardening_value}}"
      if ($value -gt 0 -and $value -le $expected) { exit 0 } else { exit 1 }
    } catch {
      exit 1
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-112_{{timestamp}}.txt'
  backup_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'InactivityTimeoutSecs'
      $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
      if ($null -eq $value) {
        'NotSet' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      } else {
        $value | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      }
    } catch {
      'NotSet' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
    }
  restore_command: |
    $ErrorActionPreference = 'Stop'
    if (Test-Path '{{backup_location}}') {
      $oldValue = Get-Content '{{backup_location}}' | Select-Object -First 1
      $regPath = 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      $regName = 'InactivityTimeoutSecs'
      try {
        if ($oldValue -eq 'NotSet') {
          Remove-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
        } else {
          Set-ItemProperty -Path $regPath -Name $regName -Value ([int]$oldValue) -Type DWord -Force
        }
      } catch {
        Write-Warning "Failed to restore registry value: $_"
      }
    }
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: local_policies
  audit_trail: true
  
reporting:
  report_section: Security Options
  priority: medium
  remediation_complexity: low
  
tags:
  - security-options
  - interactive-logon
  - inactivity-timeout
  - screen-lock
  - cis
  
notes: |
  Inactivity timeout measured in seconds.
  900 seconds = 15 minutes (basic level).
  600 seconds = 10 minutes (moderate level).
  300 seconds = 5 minutes (strict level).
  Value of 0 means no timeout (insecure).
  Works in conjunction with screen saver lock settings.
