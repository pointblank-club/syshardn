metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-130
  category: Local Policies
  subcategory: Security Options - Network Security
  description: "Ensure 'Network security: Do not store LAN Manager hash value on next password change' is set to 'Enabled'"
  severity: high
  
  audit:
    cis_reference: 2.3.11.7
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: The LAN Manager (LM) hash is a weak legacy password hash that can be easily cracked. Preventing the storage of LM hashes ensures that only more secure password hashes (NTLM and NTLMv2) are stored, significantly improving password security.
    impact: LM hashes will not be stored for new or changed passwords. This should not impact modern systems but may affect very old legacy applications that require LM authentication.
  
  hardening_levels:
    basic:
      enabled: true
      value: 1
    moderate:
      enabled: true
      value: 1
    strict:
      enabled: true
      value: 1
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      $regName = 'NoLMHash'
      if (Test-Path $regPath) {
        $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
        if ($null -eq $value) {
          Write-Output 0
        } else {
          Write-Output $value
        }
      } else {
        Write-Output 0
      }
    } catch {
      Write-Output 0
    }
  expected:
    type: number
    operator: '=='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
    $regName = 'NoLMHash'
    try {
      if (-not (Test-Path $regPath)) {
        New-Item -Path $regPath -Force | Out-Null
      }
      Set-ItemProperty -Path $regPath -Name $regName -Value {{hardening_value}} -Type DWord -Force
    } catch {
      Write-Error "Failed to set registry value: $_"
      exit 1
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      $regName = 'NoLMHash'
      $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction Stop | Select-Object -ExpandProperty $regName
      $expected = [int]"{{hardening_value}}"
      if ($value -eq $expected) { exit 0 } else { exit 1 }
    } catch {
      exit 1
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-130_{{timestamp}}.txt'
  backup_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      $regName = 'NoLMHash'
      $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
      if ($null -eq $value) {
        'NotSet' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      } else {
        $value | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      }
    } catch {
      'NotSet' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
    }
  restore_command: |
    $ErrorActionPreference = 'Stop'
    if (Test-Path '{{backup_location}}') {
      $oldValue = Get-Content '{{backup_location}}' | Select-Object -First 1
      $regPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa'
      $regName = 'NoLMHash'
      try {
        if ($oldValue -eq 'NotSet') {
          Remove-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
        } else {
          Set-ItemProperty -Path $regPath -Name $regName -Value ([int]$oldValue) -Type DWord -Force
        }
      } catch {
        Write-Warning "Failed to restore registry value: $_"
      }
    }
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: local_policies
  audit_trail: true
  
reporting:
  report_section: Security Options
  priority: high
  remediation_complexity: low
  
tags:
  - security-options
  - network-security
  - lm-hash
  - password-hash
  - cis
  
notes: |
  NoLMHash = 1 prevents storing LM hashes (secure).
  NoLMHash = 0 allows storing LM hashes (insecure).
  LM hashes are easily cracked and should never be stored.
  Applies to new or changed passwords only.
  Users should change passwords after enabling this setting.
  Modern systems use NTLM and NTLMv2 hashes which are more secure.
