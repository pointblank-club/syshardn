metadata:
  benchmark: CIS Microsoft Windows 10/11 Enterprise Benchmarks v1.12.0
  os: windows
  versions:
    - '10'
    - '11'

rule:
  id: WIN-811
  category: Windows Firewall
  subcategory: Public Profile
  description: "Ensure 'Windows Firewall: Public: Inbound connections' is set to 'Block (default)'"
  severity: critical
  
  audit:
    cis_reference: 9.3.2
    compliance_frameworks:
      - NIST SP 800-53
      - ISO 27001
      - PCI-DSS
    rationale: Setting the default action for inbound connections on public networks to Block is essential for security. Public networks are untrusted environments where attackers may be present. Blocking all inbound connections by default protects against network scanning, exploitation attempts, and unauthorized access from unknown sources.
    impact: All inbound connections on public networks will be blocked by default. Only explicitly allowed applications will receive inbound traffic. This provides maximum protection on untrusted networks. Network discovery and file sharing will not work on public networks.
  
  hardening_levels:
    basic:
      enabled: true
      value: 'block'
    moderate:
      enabled: true
      value: 'block'
    strict:
      enabled: true
      value: 'block'
  
check:
  type: command
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      $output = netsh advfirewall show publicprofile 2>&1
      if ($output -match 'InboundUserNotification\s+.*\s+BlockInbound') {
        Write-Output 'block'
      } elseif ($output -match 'InboundUserNotification\s+.*\s+AllowInbound') {
        Write-Output 'allow'
      } else {
        Write-Output 'unknown'
      }
    } catch {
      Write-Output 'unknown'
    }
  expected:
    type: string
    operator: '=='
    value: '{{hardening_value}}'
  timeout: 30
  retry: 2
  retry_delay: 5
  
remediation:
  type: command
  prerequisites:
    - admin_rights
  backup_before: true
  command: |
    $ErrorActionPreference = 'Stop'
    try {
      $action = if ('{{hardening_value}}' -eq 'block') { 'blockinbound' } else { 'allowinbound' }
      $result = netsh advfirewall set publicprofile firewallpolicy $action,allowoutbound 2>&1
      if ($LASTEXITCODE -ne 0) {
        Write-Error "Failed to set firewall policy: $result"
        exit 1
      }
    } catch {
      Write-Error "Failed to set firewall policy: $_"
      exit 1
    }
  requires_reboot: false
  timeout: 30
  verify_after: true
  verify_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $output = netsh advfirewall show publicprofile 2>&1
      $expected = '{{hardening_value}}'
      if ($expected -eq 'block' -and $output -match 'BlockInbound') {
        exit 0
      } elseif ($expected -eq 'allow' -and $output -match 'AllowInbound') {
        exit 0
      } else {
        exit 1
      }
    } catch {
      exit 1
    }
  
rollback:
  enabled: true
  backup_location: '{{backup_dir}}/WIN-811_{{timestamp}}.txt'
  backup_command: |
    $ErrorActionPreference = 'Stop'
    try {
      $output = netsh advfirewall show publicprofile 2>&1
      if ($output -match 'InboundUserNotification\s+.*\s+BlockInbound') {
        'block' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      } elseif ($output -match 'InboundUserNotification\s+.*\s+AllowInbound') {
        'allow' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      } else {
        'unknown' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
      }
    } catch {
      'unknown' | Out-File -FilePath '{{backup_location}}' -Encoding UTF8
    }
  restore_command: |
    $ErrorActionPreference = 'Stop'
    if (Test-Path '{{backup_location}}') {
      $oldPolicy = Get-Content '{{backup_location}}' | Select-Object -First 1
      try {
        if ($oldPolicy -eq 'block') {
          netsh advfirewall set publicprofile firewallpolicy blockinbound,allowoutbound | Out-Null
        } elseif ($oldPolicy -eq 'allow') {
          netsh advfirewall set publicprofile firewallpolicy allowinbound,allowoutbound | Out-Null
        }
      } catch {
        Write-Warning "Failed to restore firewall policy: $_"
      }
    }
  requires_reboot: false
  timeout: 30
  
logging:
  log_level: INFO
  log_category: windows_firewall
  audit_trail: true
  
reporting:
  report_section: Windows Firewall
  priority: critical
  remediation_complexity: low
  
tags:
  - firewall
  - windows-firewall
  - public-profile
  - inbound-connections
  - default-deny
  - untrusted-networks
  - cis
  
notes: |
  Public profile inbound policy is critical for untrusted networks.
  BlockInbound = deny all inbound unless explicitly allowed (required).
  AllowInbound = allow all inbound unless explicitly denied (dangerous).
  Public networks include airports, cafes, hotels, unknown WiFi.
  Never allow inbound on public networks without specific rules.
  Outbound connections remain allowed for normal internet access.
  This setting protects against network attacks on public WiFi.
  Most client applications work normally as they initiate outbound.
